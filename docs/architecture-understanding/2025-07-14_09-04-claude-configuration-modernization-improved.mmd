graph TB
    subgraph "CLI Layer"
        CLI[better-claude CLI]
        Cobra[Cobra Command Framework]
        Flags[Global Flags: --dry-run, --backup, --config]
        Validation[Input Validation]
    end

    subgraph "Application Layer (CQRS)"
        Commands[Command Handlers]
        Queries[Query Handlers]
        ConfigureCmd[Configure Command Handler]
        BackupCmd[Backup Command Handler]
        RestoreCmd[Restore Command Handler]
        ProfileQuery[Profile Query Handler]
        HealthQuery[Health Check Query Handler]
    end

    subgraph "Domain Layer (DDD)"
        ConfigAggregate[Configuration Aggregate]
        ProfileAggregate[Profile Aggregate]
        BackupAggregate[Backup Aggregate]
        
        DomainEvents[Domain Events]
        ConfigurationApplied[Configuration Applied Event]
        BackupCreated[Backup Created Event]
        ProfileChanged[Profile Changed Event]
        
        DomainServices[Domain Services]
        ValidationService[Validation Service]
        ProfileService[Profile Service]
    end

    subgraph "Infrastructure Layer"
        EventStore[Event Store]
        MessageBus[Watermill Message Bus]
        Repositories[Repositories]
        ConfigRepo[Configuration Repository]
        BackupRepo[Backup Repository]
        ProfileRepo[Profile Repository]
        
        ExternalServices[External Services]
        ClaudeService[Claude CLI Service]
        FileService[File System Service]
        TelemetryService[OpenTelemetry Service]
    end

    subgraph "Observability"
        Telemetry[OpenTelemetry]
        Traces[Distributed Tracing]
        Metrics[Performance Metrics]
        Logs[Structured Logging]
        HealthChecks[Health Checks]
    end

    %% CLI Layer flow
    CLI --> Cobra
    Cobra --> Flags
    Flags --> Validation
    Validation --> Commands

    %% CQRS Application Layer
    Commands --> ConfigureCmd
    Commands --> BackupCmd
    Commands --> RestoreCmd
    Queries --> ProfileQuery
    Queries --> HealthQuery

    %% Command Handlers to Domain
    ConfigureCmd --> ConfigAggregate
    BackupCmd --> BackupAggregate
    RestoreCmd --> BackupAggregate
    ProfileQuery --> ProfileAggregate

    %% Domain Layer interactions
    ConfigAggregate --> DomainEvents
    ProfileAggregate --> DomainEvents
    BackupAggregate --> DomainEvents
    
    DomainEvents --> ConfigurationApplied
    DomainEvents --> BackupCreated
    DomainEvents --> ProfileChanged

    ConfigAggregate --> DomainServices
    DomainServices --> ValidationService
    DomainServices --> ProfileService

    %% Infrastructure Layer
    DomainEvents --> EventStore
    DomainEvents --> MessageBus
    
    ConfigAggregate --> ConfigRepo
    BackupAggregate --> BackupRepo
    ProfileAggregate --> ProfileRepo

    Repositories --> FileService
    ConfigureCmd --> ClaudeService
    
    %% Observability integration
    Commands --> Telemetry
    DomainServices --> Telemetry
    ExternalServices --> Telemetry
    
    Telemetry --> Traces
    Telemetry --> Metrics
    Telemetry --> Logs
    HealthQuery --> HealthChecks

    %% Event sourcing flow
    EventStore --> MessageBus
    MessageBus --> DomainEvents

    %% Railway-oriented programming patterns
    ConfigureCmd -.->|"Result[T]"| ValidationService
    ValidationService -.->|"Pipeline"| ProfileService
    ProfileService -.->|"Compose"| ClaudeService

    classDef cli fill:#e1f5fe,stroke:#0277bd
    classDef application fill:#f3e5f5,stroke:#7b1fa2
    classDef domain fill:#e8f5e8,stroke:#2e7d32
    classDef infrastructure fill:#fff3e0,stroke:#ef6c00
    classDef observability fill:#fce4ec,stroke:#c2185b
    classDef events fill:#f1f8e9,stroke:#558b2f

    class CLI,Cobra,Flags,Validation cli
    class Commands,Queries,ConfigureCmd,BackupCmd,RestoreCmd,ProfileQuery,HealthQuery application
    class ConfigAggregate,ProfileAggregate,BackupAggregate,DomainServices,ValidationService,ProfileService domain
    class EventStore,MessageBus,Repositories,ConfigRepo,BackupRepo,ProfileRepo,ExternalServices,ClaudeService,FileService,TelemetryService infrastructure
    class Telemetry,Traces,Metrics,Logs,HealthChecks observability
    class DomainEvents,ConfigurationApplied,BackupCreated,ProfileChanged events