graph TB
    subgraph "User Commands - justfile Task Runner"
        user[User] --> just{justfile Commands}

        just --> setup[just setup<br/>Initial Setup]
        just --> switch[just switch<br/>Apply Config]
        just --> update[just update<br/>Update Flake]
        just --> clean[just clean<br/>Cleanup System]
        just --> test[just test<br/>Test Config]
        just --> rollback[just rollback<br/>Revert Changes]
    end

    subgraph "Build & Deployment Commands"
        switch --> nh[nh darwin switch<br/>Modern Deploy Tool]
        test --> drbuild[darwin-rebuild check<br/>Test Only]
        rollback --> drrollback[darwin-rebuild --rollback<br/>Revert]

        nh --> nixbuild[Nix Build Process]
        drbuild --> nixbuild
        drrollback --> nixactivate
    end

    subgraph "Nix Build Events"
        nixbuild --> eval[Evaluation Phase]
        eval --> evalmodules[Load All Modules]
        evalmodules --> evalcore[core.nix]
        evalmodules --> evalenv[environment.nix]
        evalmodules --> evalprog[programs.nix]
        evalmodules --> evalsys[system.nix]
        evalmodules --> evalbrew[homebrew.nix]
        evalmodules --> evalwrap[wrappers/default.nix]

        eval --> build[Build Phase]
        build --> derivations[Create Derivations]
        derivations --> buildpkgs[Build Packages]
        buildpkgs --> wrappers[Apply Wrappers]

        build --> activate[Activation Phase]
    end

    subgraph "System Activation Events"
        activate --> nixactivate[System Activation Scripts]
        nixactivate --> fileassoc[setFileAssociations<br/>duti commands]
        nixactivate --> finder[setFinderCalculateAllSizes<br/>defaults + killall]
        nixactivate --> register[registerApplications<br/>lsregister + mdimport]

        nixactivate --> brewactivate[Homebrew Activation]
        brewactivate --> brewupdate[brew update]
        brewactivate --> brewupgrade[brew upgrade]
        brewupgrade --> brewclean[brew cleanup --zap]
    end

    subgraph "Shell Script Commands - Ad-hoc Automation"
        user --> scripts{Shell Scripts}
        scripts --> validate[scripts/validate-wrappers.sh]
        scripts --> benchmark[scripts/benchmark-system.sh]
        scripts --> awconfig[scripts/activitywatch-config.sh]
        scripts --> optimize[scripts/optimize.sh]
        scripts --> deploy[scripts/deployment-verify.sh]
    end

    subgraph "Pre-commit Hook Events"
        user --> gitcommit[git commit]
        gitcommit --> hooks{Pre-commit Hooks}
        hooks --> gitleaks[gitleaks<br/>Secret Detection]
        hooks --> whitespace[Remove Trailing Whitespace]
        hooks --> gofmt[go fmt]
        hooks --> golint[golangci-lint]
        hooks --> nixcheck[nix check]

        gitleaks -.fail.-> reject[Commit Rejected]
        nixcheck -.pass.-> allow[Commit Allowed]
    end

    subgraph "System State Changes"
        fileassoc --> launchsvcs[Launch Services DB]
        finder --> finderprefs[Finder Preferences]
        register --> spotlight[Spotlight Index]

        wrappers --> binaries[/run/current-system/sw/bin]
        brewclean --> caskroom[/opt/homebrew/Caskroom]
        buildpkgs --> nixstore[/nix/store]
    end

    subgraph "Manual Commands - No Automation"
        user --> manual{Manual Operations}
        manual --> awstart[just activitywatch-start<br/>osascript launch]
        manual --> awstop[just activitywatch-stop<br/>pkill]
        manual --> link[just link<br/>./manual-linking.sh]
    end

    style nixactivate fill:#9cf,stroke:#069
    style hooks fill:#f99,stroke:#f00
    style nh fill:#9f9,stroke:#090
    style reject fill:#f99,stroke:#f00
    style allow fill:#9f9,stroke:#090
    style brewactivate fill:#fc9,stroke:#f90
