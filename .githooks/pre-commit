#!/usr/bin/env bash
# Simplified pre-commit hook for NixOS configuration validation

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Function to run Nix flake check
run_nix_check() {
    log_info "Running Nix flake check..."
    if nix flake check > /tmp/nix-check.log 2>&1; then
        log_success "Nix flake check passed!"
        return 0
    else
        log_error "Nix flake check failed!"
        echo -e "${RED}=== ERROR OUTPUT ===${NC}"
        cat /tmp/nix-check.log
        return 1
    fi
}

# Main execution
main() {
    log_info "üöÄ Pre-commit validation starting..."
    
    # Change to project root
    cd "$(git rev-parse --show-toplevel)"
    
    # Check if we're in a Nix project
    if [ ! -f "flake.nix" ]; then
        log_error "Not in a Nix flake project (no flake.nix found)"
        exit 1
    fi
    
    # Run Nix flake check
    if run_nix_check; then
        log_success "üéâ All validation checks passed!"
        echo -e "${GREEN}Ready to commit!${NC}"
        exit 0
    else
        log_error "‚ùå Nix flake check failed. Commit aborted."
        echo -e "${YELLOW}Fix issues above and try again.${NC}"
        exit 1
    fi
}

# Run main function
main "$@"