# Just task runner for Nix configuration management
# Provides convenient commands for validation, deployment, and development

# Default recipe - show available commands
default:
    @just --list

# Development workflow
dev:
    @echo "ğŸ”§ Starting development workflow..."
    @just validate-quick
    @echo "âœ… Ready for development!"

# Configuration validation commands
validate *ARGS:
    @echo "ğŸ” Running comprehensive configuration validation..."
    ./scripts/config-validate.sh {{ARGS}}

validate-quick:
    @echo "âš¡ Running quick validation for development..."
    ./scripts/config-validate.sh --quick

validate-strict:
    @echo "ğŸ”’ Running strict validation (warnings as errors)..."
    ./scripts/config-validate.sh --strict

validate-nix:
    @echo "â„ï¸ Validating Nix configuration..."
    ./scripts/config-validate.sh nix

validate-shell:
    @echo "ğŸš Validating shell configurations..."
    ./scripts/config-validate.sh shell

validate-deps:
    @echo "ğŸ“¦ Checking for dependency conflicts..."
    ./scripts/config-validate.sh deps

validate-report FILE="validation-report.md":
    @echo "ğŸ“Š Generating validation report..."
    ./scripts/config-validate.sh --report {{FILE}} report

# Nix system management
build:
    @echo "ğŸ—ï¸ Building Nix configuration..."
    darwin-rebuild build --flake .

switch:
    @echo "ğŸ”„ Switching to new Nix configuration..."
    just validate-strict
    darwin-rebuild switch --flake .

# Safe deployment with comprehensive validation
deploy-safe:
    @echo "ğŸ›¡ï¸ Starting safe deployment process..."
    @echo "ğŸ“‹ Step 1: Backup current configuration"
    -cp -r ~/.config ~/.config.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
    @echo "ğŸ” Step 2: Comprehensive validation"
    just validate-strict
    @echo "ğŸ—ï¸ Step 3: Build configuration"
    just build
    @echo "ğŸ”„ Step 4: Apply configuration"
    just switch
    @echo "âœ… Safe deployment completed successfully!"

# Development helpers
check:
    @echo "ğŸ” Checking Nix flake..."
    nix flake check --show-trace

update:
    @echo "ğŸ“¦ Updating flake inputs..."
    nix flake update

clean:
    @echo "ğŸ§¹ Cleaning up..."
    nix-collect-garbage -d
    nix store optimise

# Pre-commit setup and management
setup-hooks:
    @echo "ğŸª Setting up pre-commit hooks..."
    pre-commit install
    pre-commit autoupdate

run-hooks:
    @echo "ğŸ” Running pre-commit hooks on all files..."
    pre-commit run --all-files

# Troubleshooting and debugging
debug:
    @echo "ğŸ› Debug information:"
    @echo "ğŸ“ Project root: $(pwd)"
    @echo "â„ï¸ Nix version: $(nix --version)"
    @echo "ğŸ  Home Manager: $(home-manager --version 2>/dev/null || echo 'Not installed')"
    @echo "ğŸº Homebrew: $(brew --version 2>/dev/null | head -1 || echo 'Not installed')"
    @echo "ğŸš Shell: $SHELL"
    @echo "ğŸ“‹ PATH entries:"
    @echo "$PATH" | tr ':' '\n' | head -10

logs:
    @echo "ğŸ“‹ Recent validation logs:"
    @ls -la validation-*.log 2>/dev/null | head -5 || echo "No validation logs found"

# System information
info:
    @echo "ğŸ’» System Information:"
    @echo "ğŸ–¥ï¸  OS: $(uname -s) $(uname -r)"
    @echo "ğŸ—ï¸  Architecture: $(uname -m)"
    @echo "ğŸ‘¤ User: $(whoami)"
    @echo "ğŸ“ Home: $HOME"
    @echo "ğŸ”§ Git: $(git --version)"

# Configuration file management
backup:
    @echo "ğŸ’¾ Creating configuration backup..."
    @mkdir -p backups
    @tar -czf "backups/config-backup-$(date +%Y%m%d_%H%M%S).tar.gz" \
        --exclude='.git' \
        --exclude='result' \
        --exclude='validation-*.log' \
        --exclude='backups' \
        .
    @echo "âœ… Backup created in backups/ directory"

restore BACKUP:
    @echo "ğŸ”„ Restoring from backup: {{BACKUP}}"
    @tar -xzf "{{BACKUP}}" -C . --exclude='.git'
    @echo "âœ… Configuration restored"

# Performance monitoring
benchmark:
    @echo "â±ï¸ Benchmarking system performance..."
    @echo "ğŸš Shell startup times:"
    @echo -n "Fish: "; time fish -c "echo 'test'" 2>&1 | grep real || echo "Not available"
    @echo -n "Zsh: "; time zsh -c "echo 'test'" 2>&1 | grep real || echo "Not available"
    @echo -n "Bash: "; time bash -c "echo 'test'" 2>&1 | grep real || echo "Not available"

# Documentation
docs:
    @echo "ğŸ“š Available documentation:"
    @echo "ğŸ“– Configuration validation: docs/configuration-validation.md"
    @echo "ğŸ¯ Usage examples: examples/validation-usage.sh"
    @echo "ğŸ§ª Testing: test-validation.sh"

# Help and usage examples
help-validate:
    @echo "ğŸ” Configuration Validation Help"
    @echo ""
    @echo "Quick commands:"
    @echo "  just validate-quick    # Fast validation for development"
    @echo "  just validate-strict   # Comprehensive validation with warnings as errors"
    @echo "  just deploy-safe       # Safe deployment with full validation"
    @echo ""
    @echo "Specific validations:"
    @echo "  just validate-nix      # Only Nix configuration"
    @echo "  just validate-shell    # Only shell configurations"
    @echo "  just validate-deps     # Only dependency conflicts"
    @echo ""
    @echo "Reports and debugging:"
    @echo "  just validate-report   # Generate detailed validation report"
    @echo "  just debug            # Show system debug information"
    @echo "  just logs             # Show recent validation logs"

# Aliases for common operations
alias v := validate
alias vq := validate-quick
alias vst := validate-strict
alias vn := validate-nix
alias vsh := validate-shell
alias vd := validate-deps
alias b := build
alias s := switch
alias ds := deploy-safe